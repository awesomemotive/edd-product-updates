
jQuery(document).ready(function($){function eddPupRemoveMenus(){if($('#popup-wrap').length){$('#adminmenuwrap, #adminmenuback, #wpadminbar, #wpfooter, .update-nag').remove();$('#wpcontent').css('margin','-32px 0 0 0');}}
eddPupRemoveMenus();$('#cboxContent .closebutton').live('click',function(){$.fn.colorbox.close();});if($('#edd-pup-queue-details').length){$('#edd-pup-view-queue-alert').colorbox({inline:true,href:$('#edd-pup-queue-details'),width:'95%',maxWidth:'680px',height:'auto'});}
var url=document.URL;$('.edd-pup-queue-button').click(function(){var data={'action':$(this).attr('data-action'),'email':$(this).attr('data-email'),'url':$(this).attr('data-url')};if(data['action']=='edd_pup_clear_queue'){if(confirm(eddPup.c1)){$.post(ajaxurl,data).error(function(){alert(eddPup.a9);}).success(function(response){window.location.href=url+'&edd_pup_cq='+data['email'];});}}else if(data['action']=='edd_pup_send_queue'){window.open(data['url'],'targetWindow','toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=600,height=450');return false;}});var clear=decodeURIComponent((new RegExp('[?|&]'+'edd_pup_cq'+'='+'([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g,'%20'))||null;if(clear>0||clear=='all'){$('#edd-pup-view-queue-alert').trigger('click');window.history.replaceState({},'queueurl',url.replace(/&?edd_pup_cq=([^&]$|[^&]*)/i,""));}
function emailPreview(){var button=$('#edd-pup-open-preview');button.mousedown(function(){tinyMCE.triggerSave();}).click(function(){tinyMCE.triggerSave();var url=document.URL,form=$('#edd-pup-email-edit').serialize(),data={'action':'edd_pup_ajax_preview','form':form,'url':url};$.post(ajaxurl,data).error(function(){alert(eddPup.a1);button.prop("disabled",false);}).success(function(response){if($.isNumeric(response)){var u=url.replace('add_pup_email','edit_pup_email');window.location.href=u+'&id='+response+'&edd_pup_preview=1';}else{$.colorbox({html:response});}});});}
emailPreview();function emailPreviewRedirect(){var preview=decodeURIComponent((new RegExp('[?|&]'+'edd_pup_preview'+'='+'([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g,'%20'))||null;if(preview==1){var url=document.URL,form=$('#edd-pup-email-edit').serialize(),data={'action':'edd_pup_ajax_preview','form':form,'url':url};$.post(ajaxurl,data).error(function(){alert(eddPup.a1);button.prop("disabled",false);}).success(function(response){$.colorbox({html:response});});window.history.replaceState({},'newurl',url.replace(/&?edd_pup_preview=([^&]$|[^&]*)/i,""));}}
emailPreviewRedirect();function emailTest(){var button=$('#edd-pup-send-test');button.mousedown(function(){tinyMCE.triggerSave();}).click(function(){tinyMCE.triggerSave();var url=document.URL,form=$('#edd-pup-email-edit').serialize(),data={'action':'edd_pup_send_test_email','form':form,'url':url};button.attr("disabled",true);if(emailValidate($('#from_email').val())){$.post(ajaxurl,data).error(function(){alert(eddPup.a1);button.attr("disabled",false);}).success(function(response){if($.isNumeric(response)){var u=url.replace('add_pup_email','edit_pup_email');window.location.href=u+'&id='+response+'&edd_pup_test=1';}else{alert(response);button.attr("disabled",false);}});}else{button.attr("disabled",false);alert(eddPup.a2);return false;}});}
emailTest();function emailTestRedirect(){var test=decodeURIComponent((new RegExp('[?|&]'+'edd_pup_test'+'='+'([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g,'%20'))||null;if(test==1){alert(eddPup.a10);window.history.replaceState({},'newurl',url.replace(/&?edd_pup_test=([^&]$|[^&]*)/i,""));}}
emailTestRedirect();function emailConfirmPreview(){var button=$('#send-prod-updates'),spinner=$('.edd-pup-spin');button.mousedown(function(){tinyMCE.triggerSave();}).click(function(){var url=document.URL,form=$('#edd-pup-email-edit').serialize(),data={'action':'edd_pup_confirm_ajax','form':form,'url':url};if(emailValidate($('#from_email').val())){$(this).prop("disabled",true);spinner.toggleClass('loading');$.post(ajaxurl,data).error(function(){alert(eddPup.a1);spinner.toggleClass('loading');button.prop("disabled",false);}).success(function(r){if(r=='nocheck'){alert(eddPup.a3);spinner.toggleClass('loading');button.prop("disabled",false);}else if(r%1==0){var u=url.replace('add_pup_email','edit_pup_email');window.location.href=u+'&id='+r+'&edd_pup_confirm=1';}else{$.colorbox({html:r});spinner.toggleClass('loading');button.prop("disabled",false);}});return false;}else{alert(eddPup.a2);return false;}});}
emailConfirmPreview();function emailConfirmRedirect(){var button=$('#send-prod-updates'),spinner=$('.edd-pup-spin'),url=document.URL,form=$('#edd-pup-email-edit').serialize(),data={'action':'edd_pup_confirm_ajax','form':form,'url':url},confirm=decodeURIComponent((new RegExp('[?|&]'+'edd_pup_confirm'+'='+'([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g,'%20'))||null;if(confirm==1){button.prop("disabled",true);spinner.toggleClass('loading');$.post(ajaxurl,data).error(function(){alert(eddPup.a1);spinner.toggleClass('loading');button.prop("disabled",false);}).success(function(r){$.colorbox({html:r});spinner.toggleClass('loading');button.prop("disabled",false);window.history.replaceState({},'newurl',url.replace(/&?edd_pup_confirm=([^&]$|[^&]*)/i,""));});}}
emailConfirmRedirect();});function eddPupAjaxEmails(){var $=jQuery,status=$('.progress-status .status-text'),button=$('#edd-pup-ajax'),spinner=$('.edd-pup-popup-spin'),action=button.attr('data-action'),clock=$('.progress-clock'),bar=$('.progress-bar'),psent=$('.progress-sent'),pperc=$('.progress-percent'),emailid=button.attr('data-email'),ogurl=window.opener.document.location.href,i=0,it=0,data={'action':'edd_pup_ajax_start','email_id':emailid,'iteration':it};button.click(function(){if($(this).attr('data-action')=='pause'){$(this).attr({'data-action':'resume',value:eddPup.v3});return false;}else if($(this).attr('data-action')=='resume'){$(this).attr({'data-action':'pause',value:eddPup.v2});clock.timer('start');}else if($(this).attr('data-action')=='start'){$(this).prop('disabled',true);spinner.show();clock.timer('start');}
$.post(ajaxurl,data).error(function(){alert(eddPup.a6);button.prop('disabled',false).attr({'data-action':'start',value:eddPup.v1});spinner.hide();}).success(function(ret){var r=$.parseJSON(ret),p=Math.round((r.sent/r.total)*100);$('.progress-wrap').css('opacity','1');$('.progress-queue').text(prettyNumber(r.total));button.prop('disabled',false).attr({'data-action':'pause',value:eddPup.v2});spinner.hide();if(r.status=='restart'){psent.text(prettyNumber(r.sent));bar.attr('data-complete',p).css('width',p+'%');pperc.text(p+'%');eddPupAjaxTrigger(i,r.sent,r.total,emailid,0);}else{eddPupAjaxBuild(r,emailid,1,0);}
window.opener.location.href=ogurl.replace(/&?edit_pup_email=([^&]$|[^&]*)/i,"view_pup_email");});});function eddPupAjaxBuild(r,emailid,it,err){if(button.attr('data-action')!='pause'){clock.timer('pause');status.text(eddPup.s8+prettyNumber(r.processed)+eddPup.s4);return false;}
if(err==0){status.text(eddPup.s3+prettyNumber(r.processed)+eddPup.s4);}else{status.text(eddPup.s5);}
if(+r.processed>=+r.total){eddPupAjaxTrigger(0,r.sent,r.total,emailid,0);return false;}
var data={'action':'edd_pup_ajax_start','email_id':emailid,'iteration':it,'processed':r.processed,'status':'processing','error':err};$.post(ajaxurl,data).error(function(){err++;status.html(eddPup.s7);var errsec=14,errtimer=setInterval(function(){$('.progress-status .count').text(errsec--);if(errsec==0){clearInterval(errtimer);}
if(button.attr('data-action')!='pause'){clearInterval(errtimer);clearTimeout(err1);eddPupAjaxTrigger();}},1000);if(err==6){alert(eddPup.a5);return false;}
var err1=setTimeout(function()
{eddPupAjaxBuild(r,emailid,it,err);},15000);}).success(function(ret){if(err>0){status.text(eddPup.s6);}
var err=0,r=$.parseJSON(ret);it++;if(r.processed>0){status.text(eddPup.s3+prettyNumber(r.processed)+eddPup.s4);}
eddPupAjaxBuild(r,emailid,it,err);});}
function eddPupAjaxTrigger(i,s,totalEmails,emailid,err){if(button.attr('data-action')!='pause'){clock.timer('pause');status.text(eddPup.s2);return false;}
if(err==0){status.text(eddPup.s1);}else{status.text(eddPup.s5);}
if(+s>=+totalEmails){eddPupAjaxEnd(i,s,totalEmails,emailid);return false;}
$.post(ajaxurl,{'action':'edd_pup_ajax_trigger','iteration':i,'sent':s,'email_id':emailid,'errors':err}).error(function(){err++;status.html(eddPup.s7);var errsec=14,errtimer=setInterval(function(){$('.progress-status .count').text(errsec--);if(errsec==0){clearInterval(errtimer);}
if(button.attr('data-action')!='pause'){clearInterval(errtimer);clearTimeout(err2);eddPupAjaxTrigger();}},1000);if(err==6){alert(eddPup.a4);return false;}
var err2=setTimeout(function()
{eddPupAjaxTrigger(i,s,totalEmails,emailid,err);},15000);}).success(function(s){if(err>0){status.text(eddPup.s6);}
var err=0;if(!$.isNumeric(s)){alert(eddPup.a7);clock.timer('pause');return false;}
function progressColor(color1,color2){bar.removeClass(color1).addClass(color2);};var percent=Math.round((s/totalEmails)*99);if(percent!=e){psent.text(prettyNumber(s));bar.attr('data-complete',percent).css('width',percent+'%');pperc.text(percent+'%');if(percent>=25&&percent<=49){progressColor('red','orange');}else if(percent>=50&&percent<=74){progressColor('orange','yellorange');}else if(percent>=75&&percent<=98){progressColor('yellorange','yellow');}else if(percent==99){progressColor('yellow','green');}
var e=percent;}
i++;eddPupAjaxTrigger(i,s,totalEmails,emailid,err);});}
function eddPupAjaxEnd(i,s,totalEmails,emailid){status.text('Finishing up.');$.post(ajaxurl,{'action':'edd_pup_ajax_end','email_id':emailid}).error(function(){alert(eddPup.a8);}).success(function(response){status.fadeIn('fast').text('Sending complete.');bar.attr('data-complete',100).css('width',100+'%');pperc.text(100+'%');button.prop('disabled',true).attr({'data-action':'complete',value:'Finished'});var t=clock.html().split(':'),hrs=$('.success-time-h'),min=$('.success-time-m'),sec=$('.success-time-s');clock.timer('pause');$('.success-total').text(prettyNumber(s));if(t.length>2){hrs.show().text(parseInt(t[0])+' hr.');min.show().text(parseInt(t[1])+' min.');sec.text(parseInt(t[2])+' sec.');}else{if(t[0]>0){min.show().text(parseInt(t[0])+' min.');}
sec.text(parseInt(t[1])+' sec.');}
$('#completion').show();if(window.opener&&!window.opener.closed){window.opener.location.reload();}});}}
function prettyNumber(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");}
function emailValidate(email){var regex=/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;return regex.test(email);}
(function($){var Timer=function(element,options){var defaults={editable:true,restart:false,repeat:false};this.options=$.extend(defaults,options);this.$el=$(element);this.element=element;this.init();};Timer.prototype.init=function(){this.secsNum=0;this.minsNum=0;this.hrsNum=0;this.secsStr="0 sec";this.minsStr="";this.hrsStr="";this.timerId=null;this.delay=1000;this.isTimerRunning=false;if(this.options.seconds!==undefined){this.hrsNum=Math.floor(this.options.seconds/3600);this.minsNum=Math.floor((this.options.seconds-(this.hrsNum*3600))/60);this.secsNum=this.options.seconds-(this.hrsNum*3600)-(this.minsNum*60);this.timeToString();}
this.elType=this.$el.prop('tagName').toLowerCase();if(this.options.editable){this.initEditable();}
if(this.options.duration){this.duration=this.options.duration=this.convertToSeconds(this.options.duration);}};Timer.prototype.convertToSeconds=function(time){if(!isNaN(Number(time))){return time;}
time=time.toLowerCase();var seconds=0;time.replace(/([0-9]{1,2}h)?([0-9]{1,2}m)?([0-9]{1,2}s)/,function($match,$1,$2,$3){if($1)seconds+=Number($1.replace('h',''))*3600;if($2)seconds+=Number($2.replace('m',''))*60;if($3)seconds+=Number($3.replace('s',''));});return seconds;};Timer.prototype.start=function(){if(!this.isTimerRunning){this.updateTimerDisplay();this.incrementTime();this.startTimerInterval();}};Timer.prototype.pause=function(){clearInterval(this.timerId);this.isTimerRunning=false;};Timer.prototype.resume=function(){if(!this.isTimerRunning){this.startTimerInterval();}};Timer.prototype.remove=function(){this.pause();clearTimeout(this.timeOutId);$.removeData(this.element,'plugin_'+pluginName);$.removeData(this.element,'seconds');};Timer.prototype.startTimerInterval=function(){var self=this;this.timerId=setInterval(function(){self.incrementTime();},this.delay);this.isTimerRunning=true;};Timer.prototype.initEditable=function(){var self=this;this.$el.on('focus',function(){self.pause();});this.$el.on('blur',function(){var timerDisplayStr;var timerDisplayArr;if(self.elType==='input'||self.elType==='textarea'){timerDisplayStr=$(this).val().replace(/\s+/,'');}else{timerDisplayStr=$(this).html().replace(/\s+/,'');}
var matchSeconds=/\d+sec/,matchMinutes=/\d+\:\d+min/,matchHours=/\d+\:\d+\:\d+/;if(timerDisplayStr.match(matchSeconds)){self.secsNum=parseInt(timerDisplayStr.replace(/sec/,''),10)+1;if(self.secsNum>59){self.secsNum=0;self.minsNum++;}}else if(timerDisplayStr.match(matchMinutes)){timerDisplayStr=timerDisplayStr.replace(/min/,'');timerDisplayArr=timerDisplayStr.split(':');self.minsNum=parseInt(timerDisplayArr[0],10);self.secsNum=parseInt(timerDisplayArr[1],10)+1;if(self.secsNum>59){self.secsNum=0;self.minsNum++;}
if(self.minsNum>59){self.minsNum=0;self.hrsNum++;}}else if(timerDisplayStr.match(matchHours)){timerDisplayArr=timerDisplayStr.split(':');self.hrsNum=parseInt(timerDisplayArr[0],10);self.minsNum=parseInt(timerDisplayArr[1],10);self.secsNum=parseInt(timerDisplayArr[2],10)+1;if(self.secsNum>59){self.secsNum=0;self.minsNum++;}
if(self.minsNum>59){self.minsNum=0;self.hrsNum++;}}
self.resume();});};Timer.prototype.updateTimerDisplay=function(){var displayStr;if(this.hrsNum===0){if(this.secsNum<60&&this.minsNum===0){displayStr="00:"+this.secsStr;}else{displayStr=this.minsStr+":"+this.secsStr;}}else{displayStr=this.hrsStr+':'+this.minsStr+':'+this.secsStr;}
if(this.elType==='input'||this.elType==='textarea'){this.$el.val(displayStr);}else{this.$el.html(displayStr);}
this.$el.data('seconds',this.get_seconds());};Timer.prototype.timeToString=function(){this.secsStr=(this.secsNum<10)?'0'+this.secsNum:this.secsNum;this.minsStr=(this.minsNum<10)?'0'+this.minsNum:this.minsNum;this.hrsStr=this.hrsNum;};Timer.prototype.get_seconds=function(){return((this.hrsNum*3600)+(this.minsNum*60)+this.secsNum);};Timer.prototype.notify=function(){if(this.options.callback){this.options.callback();}else{alert('Time up!');}};Timer.prototype.incrementTime=function(){this.timeToString();this.updateTimerDisplay();if(this.$el.data('seconds')===this.duration){this.notify();if(this.options.repeat===true){this.duration+=this.options.duration;}}
this.secsNum++;if(this.secsNum%60===0){this.minsNum++;this.secsNum=0;}
if(this.minsNum>59&&this.minsNum%60===0)
{this.hrsNum++;this.minsNum=0;}};var pluginName='timer';$.fn[pluginName]=function(options){options=options||'start';return this.each(function(){if(!($.data(this,'plugin_'+pluginName)instanceof Timer)){$.data(this,'plugin_'+pluginName,new Timer(this,options));}
var instance=$.data(this,'plugin_'+pluginName);if(typeof options==='string'){if(typeof instance[options]==='function'){instance[options].call(instance);}}
if(typeof options==='object'){instance['start'].call(instance,options);}});};})(jQuery);